#!/usr/bin/env bash
# breweries - Open Brewery DB CLI for brewery lookups
# Usage: breweries <command> [args]

set -euo pipefail

API="https://api.openbrewerydb.org/v1/breweries"

usage() {
    cat <<EOF
Usage: breweries <command> [args]

Commands:
  search <name>     Search breweries by name
  city <city>       Find breweries in a city
  state <state>     Find breweries in a state
  type <type>       Find breweries by type (micro|nano|regional|brewpub|large|planning|bar|contract|proprietor|closed)
  random [count]    Get random breweries (default: 1)

Examples:
  breweries search "sierra nevada"
  breweries city "san diego"
  breweries state california
  breweries type brewpub
  breweries random 5
EOF
    exit 1
}

fetch() {
    curl -sf --max-time 10 "$1" || { echo "API error" >&2; exit 1; }
}

format_brewery() {
    jq -r '
        .[] | 
        "üç∫ \(.name) ‚Äî \(.city // "Unknown"), \(.state // "Unknown"), \(.brewery_type | gsub("_"; " ") | gsub("(?<a>^| )(?<b>.)"; "\(.a)\(.b | ascii_upcase)")) Brewery" +
        (if .website_url and .website_url != "" then "\n   \(.website_url)" else "" end)
    '
}

format_single_brewery() {
    jq -r '
        "üç∫ \(.name) ‚Äî \(.city // "Unknown"), \(.state // "Unknown"), \(.brewery_type | gsub("_"; " ") | gsub("(?<a>^| )(?<b>.)"; "\(.a)\(.b | ascii_upcase)")) Brewery" +
        (if .website_url and .website_url != "" then "\n   \(.website_url)" else "" end)
    '
}

cmd_search() {
    [[ -z "${1:-}" ]] && { echo "Usage: breweries search <name>" >&2; exit 1; }
    fetch "$API?by_name=$(printf '%s' "$1" | jq -sRr @uri)&per_page=10" | format_brewery
}

cmd_city() {
    [[ -z "${1:-}" ]] && { echo "Usage: breweries city <city>" >&2; exit 1; }
    fetch "$API?by_city=$(printf '%s' "$1" | jq -sRr @uri)&per_page=10" | format_brewery
}

cmd_state() {
    [[ -z "${1:-}" ]] && { echo "Usage: breweries state <state>" >&2; exit 1; }
    fetch "$API?by_state=$(printf '%s' "$1" | jq -sRr @uri)&per_page=10" | format_brewery
}

cmd_type() {
    [[ -z "${1:-}" ]] && { echo "Usage: breweries type <type>" >&2; exit 1; }
    local type="$1"
    # Validate type
    case "$type" in
        micro|nano|regional|brewpub|large|planning|bar|contract|proprietor|closed) ;;
        *) echo "Invalid type. Use: micro, nano, regional, brewpub, large, planning, bar, contract, proprietor, closed" >&2; exit 1 ;;
    esac
    fetch "$API?by_type=$type&per_page=10" | format_brewery
}

cmd_random() {
    local count="${1:-1}"
    # API returns array for random endpoint
    fetch "$API/random?size=$count" | format_brewery
}

[[ $# -lt 1 ]] && usage

case "$1" in
    search)  shift; cmd_search "$@" ;;
    city)    shift; cmd_city "$@" ;;
    state)   shift; cmd_state "$@" ;;
    type)    shift; cmd_type "$@" ;;
    random)  shift; cmd_random "$@" ;;
    -h|--help|help) usage ;;
    *) echo "Unknown command: $1" >&2; usage ;;
esac
